{% extends "base.html" %}

{% block title %}Мультиварка{% endblock %}

{% block content %}

<!-- Секция с рецептом -->
{% if recipe %}
    <div class="recipe-header mb-4">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
            <h2 class="mb-3 mb-lg-0">
                <i class="fas fa-utensils me-2"></i>Сегодняшний рецепт
            </h2>
            <div class="recipe-actions d-flex flex-column flex-sm-row gap-2">
                <button class="btn btn-success" onclick="optimizeRecipe()">
                    <i class="fas fa-magic me-2"></i>Подобрать рецепт
                </button>
            </div>

        </div>
    </div>
        
        <!-- Названия блюд -->
        <div class="recipe-header mb-4">
            <div class="row g-2">
                {% for meal_name, meal_data in recipe.меню.items() %}
                    {% if 'блюдо' in meal_data %}
                    <div class="col-12 col-sm-6 col-md-4 mb-2">
                        <div class="meal-card {{ meal_name }} {% if meal_data.get('skip_cooking', False) %}meal-card-skipped{% endif %}" style="cursor: pointer;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1" onclick="scrollToRecipe('{{ meal_name }}')">
                                    <h5 class="meal-title">
                                        <i class="fas fa-clock me-2"></i>{{ meal_name|title }}
                                    </h5>
                                    <p class="meal-dish">{{ meal_data.блюдо }}</p>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary meal-control-btn"
                                            onclick="replaceMeal('{{ meal_name }}')"
                                            title="Заменить блюдо">
                                        <i class="fas fa-sync-alt fa-lg"></i>
                                    </button>
                                    <button class="btn btn-outline-warning meal-control-btn"
                                            onclick="toggleSkipCooking('{{ meal_name }}')"
                                            title="{% if meal_data.get('skip_cooking', False) %}Включить приготовление{% else %}Не готовить{% endif %}"
                                            id="skip-btn-{{ meal_name }}">
                                        <i class="fas {% if meal_data.get('skip_cooking', False) %}fa-play{% else %}fa-pause{% endif %} fa-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- 1. Список покупок -->
        <div class="row g-3" id="shopping-list-container">
            {% if needed_products %}
                {% for product, info in needed_products.items() %}
                <div class="col-12 col-sm-6 col-lg-4">
                    <div class="product-card">
                        <div class="product-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shopping-cart me-2"></i>{{ product|title }}
                            </h5>
                        </div>
                        <div class="product-body">
                            <div class="mb-3">
                                <div class="text-center">
                                    {% if info.get('тип', 'quantity') == 'availability' %}
                                        <div class="info-display">
                                            <strong>Нужно: {{ info.единица }}</strong>
                                        </div>
                                        {% if info.есть > 0 %}
                                        <div class="info-display-secondary">
                                            Есть в наличии
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="info-display">
                                            <strong>Нужно: {{ info.нужно|format_number }} {{ info.единица }}</strong>
                                        </div>
                                        {% if info.есть > 0 %}
                                        <div class="info-display-secondary">
                                            Есть: {{ info.есть|format_number }} {{ info.единица }}
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Индикатор статуса -->
                            <div class="text-center mb-3">
                                {% if info.get('тип', 'quantity') == 'availability' %}
                                    {% if info.есть > 0 %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Есть в наличии
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Нужно купить
                                        </span>
                                    {% endif %}
                                {% else %}
                                    {% if info.есть >= info.get('всего_требуется', info.нужно) %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Достаточно
                                        </span>
                                    {% elif info.есть > 0 %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-exclamation-circle me-1"></i>Нужно докупить
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Нужно купить
                                        </span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            <!-- Кнопка покупки -->
                            <div class="d-grid">
                                {% if info.get('тип', 'quantity') == 'availability' %}
                                    <button class="btn btn-success btn-custom" onclick="buyProductAvailability('{{ product }}', '{{ info.единица }}')">
                                        <i class="fas fa-shopping-cart me-2"></i>Купил
                                    </button>
                                {% else %}
                                    <button class="btn btn-success btn-custom" onclick="buyProduct('{{ product }}', {{ info.нужно|format_number }}, '{{ info.единица }}')">
                                        <i class="fas fa-shopping-cart me-2"></i>Купил
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- Рецепты по порядку приемов пищи -->
        {% set meal_order = ['завтрак', 'второй_завтрак', 'обед', 'полдник', 'ужин'] %}
        
        <!-- Проверяем, есть ли активные рецепты -->
        {% set active_meals = [] %}
        {% for meal_name in meal_order %}
            {% if meal_name in recipe.меню and 'блюдо' in recipe.меню[meal_name] and not recipe.меню[meal_name].get('skip_cooking', False) %}
                {% set _ = active_meals.append(meal_name) %}
            {% endif %}
        {% endfor %}
        
        {% if active_meals %}
        <div class="cooking-stage-divider mb-4">
            <div class="text-center">
                <h3 class="stage-title">
                    <i class="fas fa-utensils me-2"></i>Рецепты
                </h3>
                
            </div>
        </div>
        
        <div class="row g-4">
            {% for meal_name in active_meals %}
                {% set meal_data = recipe.меню[meal_name] %}
                    <div class="col-12">
                        <div class="product-card {% if meal_data.get('готово', False) %}ready-meal{% endif %} large-recipe-card {{ meal_name }}" id="recipe-{{ meal_name }}">
                            <div class="product-header">
                                <h4 class="mb-0">
                                    <i class="fas fa-utensils me-2"></i>{{ meal_name|title }}: {{ meal_data.блюдо }}
                                </h4>
                            </div>
                            <div class="product-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="ingredients-list mb-4">
                                            <h5><i class="fas fa-list me-2"></i>Ингредиенты:</h5>
                                            <ul class="list-unstyled">
                                                {% for ingredient in meal_data.ингредиенты %}
                                                <li class="mb-2">
                                                    <i class="fas fa-circle me-2" style="color: #28a745; font-size: 0.8em;"></i>
                                                    <strong>{{ ingredient.продукт|title }}</strong>: {{ ingredient.количество|format_number }} {{ ingredient.единица }}
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        {% if 'инструкции' in meal_data %}
                                            <div class="instructions-list mb-4">
                                                <h5><i class="fas fa-clipboard-list me-2"></i>Инструкции:</h5>
                                                <ol class="ps-3">
                                                    {% for instruction in meal_data.инструкции %}
                                                    <li class="mb-2">{{ instruction }}</li>
                                                    {% endfor %}
                                                </ol>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Кнопка приготовления/съедения -->
                                {% if not meal_data.get('готово', False) %}
                                <div class="d-grid">
                                    <button class="btn btn-success btn-custom btn-lg" onclick="cookMeal('{{ meal_name }}')">
                                        <i class="fas fa-fire me-2"></i>Приготовлено
                                    </button>
                                </div>
                                {% else %}
                                <div class="d-grid">
                                    <button class="btn btn-success btn-custom btn-lg" onclick="eatMeal('{{ meal_name }}')">
                                        <i class="fas fa-utensils me-2"></i>Съел
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
            {% endfor %}
        </div>
        {% endif %}
        


<hr class="my-5">

<!-- Заголовок холодильника -->
<div class="text-center mb-4">
    <h2 class="stage-title">
        <i class="fas fa-snowflake me-2"></i>Холодильник
    </h2>
</div>

<!-- Список продуктов -->
{% if sklad %}
    <div class="warehouse-list">
        <div class="warehouse-header">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h6 class="mb-0"><i class="fas fa-box me-2"></i>Продукт</h6>
                </div>
                <div class="col-md-2 text-center">
                    <h6 class="mb-0">Количество/Наличие</h6>
                </div>
                <div class="col-md-2 text-center">
                    <h6 class="mb-0">Статус</h6>
                </div>
                <div class="col-md-2 text-center">
                    <h6 class="mb-0">Срок годности</h6>
                </div>
                <div class="col-md-2 text-center">
                    <h6 class="mb-0">Действия</h6>
                </div>
            </div>
        </div>
        
        {% for product_name, product_data in sklad.items() %}
        <div class="warehouse-item">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="product-name">
                        <i class="fas fa-box me-2"></i>{{ product_name|title }}
                    </div>
                </div>
                <div class="col-md-2">
                    {% if product_data.get('тип', 'quantity') == 'availability' %}
                        <div class="input-group input-group-sm">
                            {% if product_data.количество > 0 %}
                                <button type="button" 
                                        class="form-control text-center" 
                                        onclick="setProductAvailable('{{ product_name }}')"
                                        title="Продукт есть в наличии"
                                        style="background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724 !important; cursor: pointer;"
                                        onmouseover="this.style.backgroundColor='#c3e6cb'"
                                        onmouseout="this.style.backgroundColor='#d4edda'">
                                    ЕСТЬ
                                </button>
                            {% else %}
                                <button type="button" 
                                        class="form-control text-center" 
                                        onclick="setProductAvailable('{{ product_name }}')"
                                        title="Отметить продукт как имеющийся в наличии"
                                        style="background-color: #f8f9fa !important; border-color: #ced4da !important; color: #495057 !important; cursor: pointer;"
                                        onmouseover="this.style.backgroundColor='#e9ecef'"
                                        onmouseout="this.style.backgroundColor='#f8f9fa'">
                                    НЕТ
                                </button>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="input-group input-group-sm">
                            <input type="number" 
                                   class="form-control quick-edit" 
                                   data-product="{{ product_name }}"
                                   value="{{ product_data.количество|format_number }}" 
                                   min="0" 
                                   step="{% if product_data.единица in ['шт', 'пакетик', 'кубик', 'банка', 'упаковка', 'штука', 'штук'] %}1{% elif product_data.единица in ['г', 'мл', 'л'] %}1{% else %}0.1{% endif %}">
                            <span class="input-group-text">{{ product_data.единица }}</span>
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-2 text-center">
                    {% set expiration_status, expiration_text = get_product_expiration_status(product_data.get('срок_годности')) %}
                    {% if product_data.get('срок_годности') %}
                        {% if expiration_status == 'expired' %}
                            <span class="badge bg-danger">
                                <i class="fas fa-exclamation-triangle me-1"></i>Просрочен
                            </span>
                        {% elif expiration_status == 'expires_today' %}
                            <span class="badge" style="background-color: #fd7e14; color: white;">
                                <i class="fas fa-exclamation-triangle me-1"></i>Сегодня истекает
                            </span>
                        {% elif expiration_status == 'expiring_soon' %}
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-exclamation-triangle me-1"></i>Скоро истекает
                            </span>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="col-md-2 text-center">
                    {% if product_data.get('срок_годности') %}
                        <input type="date" 
                               class="form-control form-control-sm expiration-date" 
                               data-product="{{ product_name }}"
                               value="{{ product_data.срок_годности }}"
                               style="font-size: 0.8rem;">
                    {% else %}
                        <input type="date" 
                               class="form-control form-control-sm expiration-date" 
                               data-product="{{ product_name }}"
                               placeholder="Срок годности"
                               style="font-size: 0.8rem;">
                    {% endif %}
                </div>
                <div class="col-md-2 text-center">
                    <button type="button" 
                            class="btn btn-outline-danger btn-sm" 
                            onclick="throwAwayProduct('{{ product_name }}')"
                            title="Выбросить продукт (сбросить количество в 0)">
                        <i class="fas fa-trash me-1"></i>Выбросить
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Кнопка обновления продуктов -->
    <div class="text-center mt-5">
        <button type="button" class="btn btn-add" onclick="updateProductsAjax()">
            <i class="fas fa-sync-alt me-2"></i>Обновить продукты
        </button>
    </div>
{% else %}
    <div class="empty-state">
        <i class="fas fa-box-open"></i>
        <h3>Склад пуст</h3>
        <p>Добавьте рецепты и обновите склад, чтобы начать готовить с мультиваркой</p>
        <div class="d-flex gap-3 justify-content-center flex-wrap">
            <a href="{{ url_for('manage_recipes') }}" class="btn btn-primary btn-custom">
                <i class="fas fa-plus me-2"></i>Добавить рецепты
            </a>
            <button type="button" class="btn btn-add" onclick="updateProductsAjax()">
                <i class="fas fa-sync-alt me-2"></i>Обновить склад
            </button>
        </div>
    </div>
{% endif %}

{% endif %}

{% endblock %}

{% block scripts %}
<script>



// Функция для отметки блюда как приготовленного
function cookMeal(mealName) {
    fetch('/api/cook_meal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            meal_name: mealName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Уведомление убрано по запросу пользователя

            // Обновляем интерфейс без перезагрузки страницы
            setTimeout(() => {
                // Обновляем кнопку приготовления
                const cookButton = document.querySelector(`button[onclick="cookMeal('${mealName}')"]`);
                if (cookButton) {
                    cookButton.innerHTML = '<i class="fas fa-check-circle me-2"></i>Готово';
                    cookButton.className = 'btn btn-success btn-custom btn-lg';
                    cookButton.disabled = true;
                }

                // Обновляем карточку блюда
                const mealCard = document.querySelector(`.${mealName}`);
                if (mealCard) {
                    mealCard.classList.add('ready-meal');
                }

                // Обновляем детальную карточку рецепта
                const recipeCard = document.getElementById(`recipe-${mealName}`);
                if (recipeCard) {
                    recipeCard.classList.add('ready-meal');
                    // Обновляем кнопку приготовления на кнопку "Съел"
                    const cookButton = recipeCard.querySelector(`button[onclick="cookMeal('${mealName}')"]`);
                    if (cookButton) {
                        cookButton.outerHTML = `
                            <button class="btn btn-success btn-custom btn-lg" onclick="eatMeal('${mealName}')">
                                <i class="fas fa-utensils me-2"></i>Съел
                            </button>
                        `;
                    }
                }
            }, 1000);
        } else {
            console.error('Ошибка при приготовлении:', data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка запроса:', error);
    });
}

// Функция для отметки блюда как съеденного
function eatMeal(mealName) {
    fetch('/api/cook_meal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            meal_name: mealName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Уведомление убрано по запросу пользователя

            // Обновляем интерфейс без перезагрузки страницы
            setTimeout(() => {
                // Заменяем кнопку "Съел" на сообщение об успешном завершении
                const recipeCard = document.getElementById(`recipe-${mealName}`);
                if (recipeCard) {
                    const eatButton = recipeCard.querySelector(`button[onclick="eatMeal('${mealName}')"]`);
                    if (eatButton) {
                        eatButton.outerHTML = `
                            <div class="text-center text-muted small">
                                Продукты удалены из холодильника
                            </div>
                        `;
                    }
                }
            }, 1000);
        } else {
            console.error('Ошибка при отметке блюда как съеденного:', data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка запроса:', error);
    });
}

// Функция для обновления всех статусов продуктов на странице
function updateAllProductStatuses() {
    const expirationInputs = document.querySelectorAll('.expiration-date');
    expirationInputs.forEach(input => {
        const productName = input.dataset.product;
        const expirationDate = input.value;
        if (productName) {
            updateProductStatus(productName, expirationDate);
        }
    });
}

// Автоматическое сохранение при изменении значения
document.addEventListener('DOMContentLoaded', function() {
    // Обновляем все статусы продуктов при загрузке страницы
    updateAllProductStatuses();
    
    // Запускаем автообновление
    startAutoUpdate();
    
    // Инициализируем синхронизацию карточек рецептов при загрузке
    initializeRecipeCardsSynchronization();
    
    // Останавливаем автообновление при уходе со страницы
    window.addEventListener('beforeunload', stopAutoUpdate);
    const inputs = document.querySelectorAll('.quick-edit');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            const product = this.dataset.product;
            const quantity = parseFloat(this.value);
            
            if (!isNaN(quantity) && quantity >= 0) {
                fetch(`/api/update/${encodeURIComponent(product)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quantity: quantity
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Показываем краткое уведомление
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        notification.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>
                            ${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(notification);
                        
                        // Удаляем уведомление через 3 секунды
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 3000);
                        
                        // Обновляем список покупок
                        setTimeout(async () => {
                            await updateShoppingListFromAPI();
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('Ошибка обновления:', error);
                });
            }
        });
    });
    
    // Обработка изменения срока годности
    const expirationInputs = document.querySelectorAll('.expiration-date');
    expirationInputs.forEach(input => {
        input.addEventListener('change', function() {
            const product = this.dataset.product;
            const expirationDate = this.value;
            
            // Сначала получаем текущее количество продукта
            const quantityInput = document.querySelector(`input[data-product="${product}"]`);
            const currentQuantity = quantityInput ? parseFloat(quantityInput.value) || 0 : 0;
            
            fetch(`/api/update/${encodeURIComponent(product)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    quantity: currentQuantity, // Сохраняем текущее количество
                    expiration_date: expirationDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем статус продукта на основе нового срока годности
                    updateProductStatus(product, expirationDate);
                } else {
                    console.error('Ошибка обновления срока годности:', data.error);
                }
            })
            .catch(error => {
                console.error('Ошибка обновления срока годности:', error);
            });
        });
    });
});

// Функция для сброса количества продукта в 0
function throwAwayProduct(productName) {
    fetch(`/api/update/${encodeURIComponent(productName)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quantity: 0,
                expiration_date: null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Уведомление убрано по запросу пользователя
                
                // Обновляем значение в поле ввода
                const input = document.querySelector(`input[data-product="${productName}"]`);
                if (input) {
                    input.value = 0;
                }
                
                // Очищаем срок годности - используем более надежный поиск
                let expirationInput = document.querySelector(`input.expiration-date[data-product="${productName}"]`);
                if (!expirationInput) {
                    // Альтернативный поиск - ищем по всем input с data-product
                    const allInputs = document.querySelectorAll(`input[data-product="${productName}"]`);
                    expirationInput = Array.from(allInputs).find(input => input.classList.contains('expiration-date'));
                }
                
                if (!expirationInput) {
                    // Еще один альтернативный поиск - ищем по типу input[type="date"]
                    const allDateInputs = document.querySelectorAll(`input[type="date"][data-product="${productName}"]`);
                    if (allDateInputs.length > 0) {
                        expirationInput = allDateInputs[0];
                    }
                }
                
                if (expirationInput) {
                    expirationInput.value = '';
                    console.log(`Очищен срок годности для ${productName}`);
                } else {
                    console.log(`Не найден input срока годности для ${productName}`);
                }
                
                // Обновляем кнопку "ЕСТЬ" для продуктов с типом availability
                const availabilityButton = document.querySelector(`button[onclick="setProductAvailable('${productName}')"]`);
                if (availabilityButton) {
                    availabilityButton.textContent = 'НЕТ';
                    availabilityButton.style.backgroundColor = '#f8f9fa';
                    availabilityButton.style.color = '#495057';
                    availabilityButton.style.borderColor = '#ced4da';
                    availabilityButton.title = 'Отметить продукт как имеющийся в наличии';
                }
                
                // Обновляем статус продукта (скрываем, так как продукт выброшен)
                updateProductStatus(productName, null);
                
                // Обновляем список покупок после выбрасывания продукта
                setTimeout(async () => {
                    await updateShoppingListFromAPI();
                }, 500);
            } else {
                console.error(`Ошибка при выбрасывании ${productName}:`, data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка запроса:', error);
        });
}

// Функция для установки продукта с простым наличием в состояние "есть"
function setProductAvailable(productName) {
    fetch(`/api/update/${encodeURIComponent(productName)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            quantity: 1,
            expiration_date: null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Уведомление убрано по запросу пользователя
            
            // Обновляем кнопку и статус продукта
            const button = document.querySelector(`button[onclick="setProductAvailable('${productName}')"]`);
            if (button) {
                button.textContent = 'ЕСТЬ';
                button.style.backgroundColor = '#d4edda';
                button.style.color = '#155724';
                button.style.borderColor = '#c3e6cb';
                button.title = 'Продукт есть в наличии';
            }
            
            // Обновляем статус продукта (без срока годности)
            updateProductStatus(productName, null);
            
            // Обновляем список покупок
            setTimeout(async () => {
                await updateShoppingListFromAPI();
            }, 500);
        } else {
            console.error(`Ошибка при установке наличия ${productName}:`, data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка запроса:', error);
    });
}

// Функция для подбора рецепта (подбирает блюда с минимумом покупок, но сохраняет все приемы пищи)
function optimizeRecipe() {
    // Добавляем индикатор загрузки на кнопку
    const button = event.target.closest('button');
    
    // Если кнопка уже заблокирована, не выполняем действие
    if (button.disabled) {
        return;
    }
    
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Подбираем...';
    button.disabled = true;
    
    fetch('/api/optimize_recipe', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Обновляем все карточки блюд
            updateAllMealCards(data.optimized_recipe);
            
            // Обновляем список покупок
            updateShoppingList(data.needed_products);
            
            // Возвращаем кнопку в исходное состояние
            button.innerHTML = originalContent;
            button.disabled = false;
        } else {
            console.error('Ошибка при оптимизации рецепта:', data.error);
            // Возвращаем кнопку в исходное состояние при ошибке
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Ошибка запроса:', error);
        // Возвращаем кнопку в исходное состояние при ошибке
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

// Функция для замены конкретного блюда
function replaceMeal(mealType) {
    // Добавляем индикатор загрузки на кнопку
    const button = event.target.closest('button');
    
    // Если кнопка уже заблокирована, не выполняем действие
    if (button.disabled) {
        return;
    }
    
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch('/api/replace_meal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            meal_type: mealType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Обновляем только карточку конкретного блюда
            updateMealCard(mealType, data.new_meal_data);
            
            // Обновляем список покупок
            updateShoppingList(data.needed_products);
            
            // Разблокируем кнопку после успешного выполнения
            button.innerHTML = originalContent;
            button.disabled = false;
        } else {
            console.error('Ошибка при замене блюда:', data.error);
            // Возвращаем кнопку в исходное состояние при ошибке
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Ошибка запроса:', error);
        // Возвращаем кнопку в исходное состояние при ошибке
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

// Функция для покупки отдельного продукта
async function buyProduct(productName, neededAmount, unit) {
    const amount = await promptWithModal(
        `Покупка: ${productName}`,
        `Сколько ${productName} вы купили?`,
        `Рекомендуется: ${neededAmount} ${unit}`,
        neededAmount,
        'number'
    );
    
    if (amount !== null && !isNaN(parseFloat(amount)) && parseFloat(amount) >= 0) {
        const quantity = parseFloat(amount);
        
        fetch('/api/buy_single_product', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product: productName,
                quantity: quantity,
                unit: unit,
                product_type: 'quantity',
                expiration_date: null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Уведомление убрано по запросу пользователя
                
                // Обновляем интерфейс без перезагрузки страницы
                setTimeout(async () => {
                    // Обновляем значение в поле ввода
                    const input = document.querySelector(`input[data-product="${productName}"]`);
                    if (input) {
                        input.value = quantity;
                    }
                    
                    // Обновляем статус продукта
                    updateProductStatus(productName, null);
                    
                    // Обновляем список покупок
                    await updateShoppingListFromAPI();
                }, 500);
            } else {
                console.error('Ошибка при покупке продукта:', data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка запроса:', error);
        });
    }
}

// Функция для покупки продукта с простым наличием
function buyProductAvailability(productName, unit) {
    fetch('/api/buy_single_product', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product: productName,
                quantity: 1,
                unit: unit,
                product_type: 'availability',
                expiration_date: null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Уведомление убрано по запросу пользователя
                
                // Обновляем интерфейс без перезагрузки страницы
                setTimeout(async () => {
                    // Обновляем кнопку и статус продукта
                    const button = document.querySelector(`button[onclick="setProductAvailable('${productName}')"]`);
                    if (button) {
                        button.textContent = 'ЕСТЬ';
                        button.style.backgroundColor = '#d4edda';
                        button.style.color = '#155724';
                        button.style.borderColor = '#c3e6cb';
                        button.title = 'Продукт есть в наличии';
                    }
                    
                    // Обновляем статус продукта (без срока годности)
                    updateProductStatus(productName, null);
                    
                    // Обновляем список покупок
                    await updateShoppingListFromAPI();
                }, 500);
            } else {
                console.error('Ошибка при покупке продукта:', data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка запроса:', error);
        });
}

// Функция для синхронизации видимости основной карточки рецепта
function syncRecipeCardVisibility(mealType, skipStatus) {
    let recipeCard = document.getElementById(`recipe-${mealType}`);
    
    if (skipStatus) {
        // Блюдо на паузе - скрываем основную карточку если она есть
        if (recipeCard) {
            recipeCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            recipeCard.style.opacity = '0';
            recipeCard.style.transform = 'scale(0.95)';
            setTimeout(() => {
                recipeCard.style.display = 'none';
            }, 300);
        }
    } else {
        // Блюдо активно - показываем карточку или создаем если её нет
        if (!recipeCard) {
            // Карточка не существует - создаем её динамически
            createRecipeCard(mealType);
            recipeCard = document.getElementById(`recipe-${mealType}`);
        }
        
        if (recipeCard) {
            recipeCard.style.display = 'block';
            setTimeout(() => {
                recipeCard.style.opacity = '1';
                recipeCard.style.transform = 'scale(1)';
            }, 10);
        }
    }
}

// Функция для создания карточки рецепта динамически
async function createRecipeCard(mealType) {
    try {
        // Получаем текущий рецепт
        const response = await fetch('/api/current_recipe');
        const data = await response.json();
        
        if (!data.success || !data.recipe || !data.recipe.меню[mealType]) {
            console.warn(`Не удалось получить данные для создания карточки ${mealType}`);
            return;
        }
        
        const mealData = data.recipe.меню[mealType];
        const recipesContainer = document.querySelector('.row.g-4');
        if (!recipesContainer) {
            console.warn('Контейнер для рецептов не найден');
            return;
        }
        
        // Создаем HTML карточки рецепта
        const recipeCardHTML = `
            <div class="col-12">
                <div class="product-card large-recipe-card ${mealType}" id="recipe-${mealType}">
                    <div class="product-header">
                        <h4 class="mb-0">
                            <i class="fas fa-utensils me-2"></i>${mealType.charAt(0).toUpperCase() + mealType.slice(1)}: ${mealData.блюдо}
                        </h4>
                    </div>
                    <div class="product-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="ingredients-list mb-4">
                                    <h5><i class="fas fa-list me-2"></i>Ингредиенты:</h5>
                                    <ul class="list-unstyled">
                                        ${mealData.ингредиенты ? mealData.ингредиенты.map(ingredient => `
                                            <li class="mb-2">
                                                <i class="fas fa-circle me-2" style="color: #28a745; font-size: 0.8em;"></i>
                                                <strong>${ingredient.продукт.charAt(0).toUpperCase() + ingredient.продукт.slice(1)}</strong>: ${ingredient.количество} ${ingredient.единица}
                                            </li>
                                        `).join('') : ''}
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                ${mealData.инструкции ? `
                                    <div class="instructions-list mb-4">
                                        <h5><i class="fas fa-clipboard-list me-2"></i>Инструкции:</h5>
                                        <ol class="ps-3">
                                            ${mealData.инструкции.map(instruction => `
                                                <li class="mb-2">${instruction}</li>
                                            `).join('')}
                                        </ol>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Кнопка приготовления/съедения -->
                        ${mealData.готово ? `
                        <div class="d-grid">
                            <button class="btn btn-success btn-custom btn-lg" onclick="eatMeal('${mealType}')">
                                <i class="fas fa-utensils me-2"></i>Съел
                            </button>
                        </div>
                        ` : `
                        <div class="d-grid">
                            <button class="btn btn-success btn-custom btn-lg" onclick="cookMeal('${mealType}')">
                                <i class="fas fa-fire me-2"></i>Приготовлено
                            </button>
                        </div>
                        `}
                    </div>
                </div>
            </div>
        `;
        
        // Вставляем карточку в правильном порядке
        const mealOrder = ['завтрак', 'второй_завтрак', 'обед', 'полдник', 'ужин'];
        const mealIndex = mealOrder.indexOf(mealType);
        const existingCards = recipesContainer.querySelectorAll('.large-recipe-card');
        
        let insertBeforeCard = null;
        for (let i = 0; i < existingCards.length; i++) {
            const cardMealType = existingCards[i].classList.value.split(' ').find(cls => mealOrder.includes(cls));
            if (cardMealType && mealOrder.indexOf(cardMealType) > mealIndex) {
                insertBeforeCard = existingCards[i].closest('.col-12');
                break;
            }
        }
        
        if (insertBeforeCard) {
            insertBeforeCard.insertAdjacentHTML('beforebegin', recipeCardHTML);
        } else {
            recipesContainer.insertAdjacentHTML('beforeend', recipeCardHTML);
        }
        
    } catch (error) {
        console.error(`Ошибка создания карточки рецепта для ${mealType}:`, error);
    }
}

// Функция для инициализации синхронизации карточек при загрузке страницы
function initializeRecipeCardsSynchronization() {
    const mealTypes = ['завтрак', 'второй_завтрак', 'обед', 'полдник', 'ужин'];
    
    mealTypes.forEach(mealType => {
        // Ищем кнопку skip для этого типа приема пищи
        const skipButton = document.getElementById(`skip-btn-${mealType}`);
        if (skipButton) {
            // Определяем текущий статус по иконке кнопки
            const icon = skipButton.querySelector('i');
            const isSkipped = icon && icon.classList.contains('fa-play');
            
            // Синхронизируем основную карточку рецепта
            syncRecipeCardVisibility(mealType, isSkipped);
        }
    });
}

// Функция для обновления карточки блюда без перезагрузки страницы
function updateMealCard(mealType, mealData) {
    // Обновляем название блюда в карточке меню
    const mealCards = document.querySelectorAll('.meal-card');
    mealCards.forEach(card => {
        const cardButton = card.querySelector(`button[onclick="replaceMeal('${mealType}')"]`);
        if (cardButton) {
            const dishElement = card.querySelector('.meal-dish');
            if (dishElement && mealData.блюдо) {
                dishElement.textContent = mealData.блюдо;
            }
            
            // Возвращаем кнопку в исходное состояние
            cardButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
            cardButton.disabled = false;
            
            // Обновляем кнопку "не готовить" если она есть
            const skipButton = document.getElementById(`skip-btn-${mealType}`);
            if (skipButton) {
                const skipStatus = mealData.skip_cooking || false;
                const icon = skipButton.querySelector('i');
                
                if (skipStatus) {
                    icon.className = 'fas fa-play';
                    skipButton.title = 'Включить приготовление';
                    skipButton.className = 'btn btn-outline-success meal-control-btn';
                    card.classList.add('meal-card-skipped');
                } else {
                    icon.className = 'fas fa-pause';
                    skipButton.title = 'Не готовить';
                    skipButton.className = 'btn btn-outline-warning meal-control-btn';
                    card.classList.remove('meal-card-skipped');
                }
            }
            
            // Убеждаемся, что цветовой класс типа приема пищи сохранен
            const mealTypes = ['завтрак', 'второй_завтрак', 'обед', 'полдник', 'ужин'];
            mealTypes.forEach(type => {
                if (type !== mealType) {
                    card.classList.remove(type);
                }
            });
            card.classList.add(mealType);
        }
    });
    
    // Обновляем детальную карточку рецепта
    const recipeCard = document.getElementById(`recipe-${mealType}`);
    if (recipeCard && mealData.блюдо) {
        // Обновляем цветовые классы для большой карточки
        const mealTypes = ['завтрак', 'второй_завтрак', 'обед', 'полдник', 'ужин'];
        mealTypes.forEach(type => {
            if (type !== mealType) {
                recipeCard.classList.remove(type);
            }
        });
        recipeCard.classList.add(mealType);
        
        // Обновляем заголовок
        const titleElement = recipeCard.querySelector('.product-header h4, .product-header h5');
        if (titleElement) {
            titleElement.innerHTML = `<i class="fas fa-utensils me-2"></i>${mealType.charAt(0).toUpperCase() + mealType.slice(1)}: ${mealData.блюдо}`;
        }
        
        // Обновляем ингредиенты
        if (mealData.ингредиенты) {
            const ingredientsList = recipeCard.querySelector('.ingredients-list ul');
            if (ingredientsList) {
                ingredientsList.innerHTML = '';
                mealData.ингредиенты.forEach(ingredient => {
                    const li = document.createElement('li');
                    li.className = 'mb-1';
                    
                    // Форматируем количество
                    const formatNumber = (num) => {
                        return Number.isInteger(num) ? num.toString() : num.toFixed(1).replace(/\.0$/, '');
                    };
                    
                    li.innerHTML = `
                        <i class="fas fa-circle me-2" style="color: #28a745; font-size: 0.8em;"></i>
                        ${ingredient.продукт.charAt(0).toUpperCase() + ingredient.продукт.slice(1)}: ${formatNumber(ingredient.количество)} ${ingredient.единица}
                    `;
                    ingredientsList.appendChild(li);
                });
            }
        }
        
        // Обновляем инструкции
        if (mealData.инструкции) {
            const instructionsList = recipeCard.querySelector('.instructions-list ol');
            if (instructionsList) {
                instructionsList.innerHTML = '';
                mealData.инструкции.forEach(instruction => {
                    const li = document.createElement('li');
                    li.className = 'mb-1';
                    li.textContent = instruction;
                    instructionsList.appendChild(li);
                });
            }
        }

        // Обновляем кнопку для готовых блюд
        if (mealData.готово) {
            const cookButton = recipeCard.querySelector(`button[onclick="cookMeal('${mealType}')"]`);
            if (cookButton) {
                cookButton.outerHTML = `
                    <button class="btn btn-success btn-custom btn-lg" onclick="eatMeal('${mealType}')">
                        <i class="fas fa-utensils me-2"></i>Съел
                    </button>
                `;
            }
        }

        // Синхронизируем основную карточку рецепта (скрываем/показываем при skip_cooking)
        syncRecipeCardVisibility(mealType, mealData.skip_cooking || false);
    }
}

// Функция для обновления всех карточек блюд (для оптимизации рецепта)
function updateAllMealCards(optimizedRecipe) {
    if (!optimizedRecipe || !optimizedRecipe.меню) return;
    
    Object.entries(optimizedRecipe.меню).forEach(([mealType, mealData]) => {
        updateMealCard(mealType, mealData);
    });
}

// Функция для обновления списка покупок
function updateShoppingList(neededProducts) {
    const shoppingSection = document.getElementById('shopping-list-container');
    if (!shoppingSection) return;
    
    if (!neededProducts || Object.keys(neededProducts).length === 0) {
        // Если продуктов не нужно, просто очищаем секцию
        shoppingSection.innerHTML = '';
        return;
    }
    
    // Создаем новые карточки продуктов
    let newHTML = '';
    Object.entries(neededProducts).forEach(([product, info]) => {
        let statusBadge = '';
        if (info.тип === 'availability') {
            if (info.есть > 0) {
                statusBadge = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Есть в наличии</span>';
            } else {
                statusBadge = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Нужно купить</span>';
            }
        } else {
            const totalRequired = info.всего_требуется || info.нужно;
            if (info.есть >= totalRequired) {
                statusBadge = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Достаточно</span>';
            } else if (info.есть > 0) {
                statusBadge = '<span class="badge bg-warning text-dark"><i class="fas fa-exclamation-circle me-1"></i>Нужно докупить</span>';
            } else {
                statusBadge = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Нужно купить</span>';
            }
        }
        
        // Форматируем числа (убираем ненужные десятичные знаки)
        const formatNumber = (num) => {
            return Number.isInteger(num) ? num.toString() : num.toFixed(1).replace(/\.0$/, '');
        };
        
        let productInfo = '';
        let secondaryInfo = '';
        let buttonOnClick = '';
        
        if (info.тип === 'availability') {
            productInfo = `<strong>Нужно: ${info.единица}</strong>`;
            if (info.есть > 0) {
                secondaryInfo = '<div class="info-display-secondary">Есть в наличии</div>';
            }
            buttonOnClick = `buyProductAvailability('${product}', '${info.единица}')`;
        } else {
            productInfo = `<strong>Нужно: ${formatNumber(info.нужно)} ${info.единица}</strong>`;
            if (info.есть > 0) {
                secondaryInfo = `<div class="info-display-secondary">Есть: ${formatNumber(info.есть)} ${info.единица}</div>`;
            }
            buttonOnClick = `buyProduct('${product}', ${formatNumber(info.нужно)}, '${info.единица}')`;
        }
        
        newHTML += `
            <div class="col-12 col-sm-6 col-lg-4">
                <div class="product-card">
                    <div class="product-header">
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>${product.charAt(0).toUpperCase() + product.slice(1)}
                        </h5>
                    </div>
                    <div class="product-body">
                        <div class="mb-3">
                            <div class="text-center">
                                <div class="info-display">
                                    ${productInfo}
                                </div>
                                ${secondaryInfo}
                            </div>
                        </div>
                        
                        <div class="text-center mb-3">
                            ${statusBadge}
                        </div>
                        
                        <div class="d-grid">
                            <button class="btn btn-success btn-custom" onclick="${buttonOnClick}">
                                <i class="fas fa-shopping-cart me-2"></i>Купил
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    shoppingSection.innerHTML = newHTML;
}

// Функция для переключения статуса "не готовить"
function toggleSkipCooking(mealType) {
    // Получаем кнопку и проверяем, не заблокирована ли она уже
    const button = document.getElementById(`skip-btn-${mealType}`);
    
    // Если кнопка уже заблокирована, не выполняем действие
    if (button.disabled) {
        return;
    }
    
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch('/api/toggle_skip_cooking', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            meal_type: mealType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Обновляем иконку и подсказку кнопки
            const icon = button.querySelector('i');
            const newStatus = data.skip_cooking;
            
            if (newStatus) {
                icon.className = 'fas fa-play';
                button.title = 'Включить приготовление';
                button.className = 'btn btn-outline-success meal-control-btn';
            } else {
                icon.className = 'fas fa-pause';
                button.title = 'Не готовить';
                button.className = 'btn btn-outline-warning meal-control-btn';
            }
            
            // Обновляем стиль карточки
            const mealCard = button.closest('.meal-card');
            if (newStatus) {
                mealCard.classList.add('meal-card-skipped');
            } else {
                mealCard.classList.remove('meal-card-skipped');
            }
            
            // Убеждаемся, что цветовой класс типа приема пищи сохранен
            const mealTypes = ['завтрак', 'второй_завтрак', 'обед', 'полдник', 'ужин'];
            mealTypes.forEach(type => {
                if (type !== mealType) {
                    mealCard.classList.remove(type);
                }
            });
            mealCard.classList.add(mealType);
            
            // Синхронизируем основную карточку рецепта (скрываем/показываем)
            syncRecipeCardVisibility(mealType, newStatus);
            
            // Уведомление убрано по запросу пользователя
            
            // Обновляем список покупок после изменения статуса
            if (data.needed_products !== undefined) {
                updateShoppingList(data.needed_products);
            }
            
            // Разблокируем кнопку после успешного выполнения
            button.disabled = false;
        } else {
            console.error('Ошибка при переключении статуса:', data.error);
            // Возвращаем кнопку в исходное состояние при ошибке
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Ошибка запроса:', error);
        // Возвращаем кнопку в исходное состояние при ошибке
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

// Функция для обновления списка покупок после переключения статуса блюда
function updateShoppingListAfterToggle(mealType, skipStatus) {
    // Список покупок уже обновлен в ответе API toggle_skip_cooking
    // Эта функция вызывается из toggleSkipCooking с обновленными данными
    console.log(`Статус ${mealType} изменен на: ${skipStatus ? 'не готовить' : 'готовить'}`);
}

// Функция для обновления статуса продукта на основе срока годности
function updateProductStatus(productName, expirationDate) {
    // Находим элемент статуса для этого продукта - используем более надежный способ
    let expirationInput = document.querySelector(`input.expiration-date[data-product="${productName}"]`);
    if (!expirationInput) {
        // Альтернативный поиск - ищем по всем input с data-product
        const allInputs = document.querySelectorAll(`input[data-product="${productName}"]`);
        expirationInput = Array.from(allInputs).find(input => input.classList.contains('expiration-date'));
    }
    
    if (!expirationInput) {
        // Еще один альтернативный поиск - ищем по типу input[type="date"]
        const allDateInputs = document.querySelectorAll(`input[type="date"][data-product="${productName}"]`);
        if (allDateInputs.length > 0) {
            expirationInput = allDateInputs[0];
        }
    }
    
    if (!expirationInput) {
        console.log(`Не найден input срока годности для ${productName} в updateProductStatus`);
        return;
    }
    
    const warehouseItem = expirationInput.closest('.warehouse-item');
    if (!warehouseItem) {
        console.log(`Не найден warehouse-item для ${productName}`);
        return;
    }
    
    // Ищем badge в колонке статуса (вторая колонка с классом col-md-2)
    const statusColumn = warehouseItem.querySelector('.col-md-2.text-center');
    if (!statusColumn) {
        console.log(`Не найден столбец статуса для ${productName}`);
        return;
    }
    
    let statusBadge = statusColumn.querySelector('.badge');
    if (!statusBadge) {
        // Если badge не найден, создаем его
        statusBadge = document.createElement('span');
        statusBadge.className = 'badge';
        statusColumn.appendChild(statusBadge);
    }
    
    // Если срок годности не указан - не показываем никакого статуса
    if (!expirationDate || expirationDate.trim() === '') {
        statusBadge.style.display = 'none';
        return;
    }
    
    const today = new Date();
    const expDate = new Date(expirationDate);
    
    // Проверяем, что дата валидна
    if (isNaN(expDate.getTime())) {
        console.log(`Некорректная дата для ${productName}: ${expirationDate}`);
        statusBadge.style.display = 'none';
        return;
    }
    
    const daysUntilExpiration = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
    
    // Обновляем статус на основе срока годности
    if (daysUntilExpiration < 0) {
        statusBadge.className = 'badge bg-danger';
        statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Просрочен';
        statusBadge.style.display = 'inline-block';
    } else if (daysUntilExpiration === 0) {
        statusBadge.className = 'badge';
        statusBadge.style.backgroundColor = '#fd7e14';
        statusBadge.style.color = 'white';
        statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Сегодня истекает';
        statusBadge.style.display = 'inline-block';
    } else if (daysUntilExpiration <= 2) {
        statusBadge.className = 'badge bg-warning text-dark';
        statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Скоро истекает';
        statusBadge.style.display = 'inline-block';
    } else {
        // Срок годности в порядке - не показываем статус
        statusBadge.style.display = 'none';
    }
    
    console.log(`Статус обновлен для ${productName}: ${daysUntilExpiration} дней до истечения`);
}

// Функция для обновления продуктов через AJAX
async function updateProductsAjax() {
    // Создаем красивое модальное окно с подтверждением
    const confirmed = await confirmUpdateProducts();
    if (!confirmed) {
        return;
    }
    
    const button = event.target;
    
    // Показываем индикатор загрузки на кнопке
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Обновляем...';
    button.disabled = true;
    
    fetch('/update_products', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => {
        if (response.redirected) {
            // Обновляем страницу, но показываем уведомление о перенаправлении
            showNotification('Продукты обновлены! Страница будет обновлена...', 'success');
            setTimeout(() => {
                window.location.href = response.url;
            }, 1500);
        } else {
            return response.text();
        }
    })
    .then(html => {
        if (html) {
            // Если получили HTML ответ, обновляем страницу
            document.documentElement.innerHTML = html;
        }
    })
    .catch(error => {
        console.error('Ошибка обновления продуктов:', error);
        showNotification('Ошибка при обновлении продуктов', 'danger');
        
        // Возвращаем кнопку в исходное состояние при ошибке
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

// Функция подтверждения обновления продуктов
function confirmUpdateProducts() {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-sync-alt me-2"></i>Подтверждение обновления
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Вы уверены, что хотите обновить склад?</strong></p>
                        <p>Это действие:</p>
                        <ul>
                            <li>• Удалит продукты, не используемые в рецептах</li>
                            <li>• Добавит недостающие продукты из рецептов</li>
                            <li>• Обновит единицы измерения при необходимости</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resolve(false)">
                            <i class="fas fa-times me-2"></i>Отмена
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="resolve(true)">
                            <i class="fas fa-check me-2"></i>Да, обновить
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        
        // Добавляем обработчики для кнопок
        modal.querySelector('.btn-secondary').onclick = () => {
            bsModal.hide();
            resolve(false);
        };
        modal.querySelector('.btn-primary').onclick = () => {
            bsModal.hide();
            resolve(true);
        };
        
        // Убираем модальное окно после закрытия
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
        
        bsModal.show();
    });
}

// Универсальная функция для создания модальных окон ввода
function promptWithModal(title, question, hint = '', defaultValue = '', inputType = 'text') {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-question-circle me-2"></i>${title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>${question}</strong></p>
                        ${hint ? `<p class="text-muted"><small>${hint}</small></p>` : ''}
                        <div class="mb-3">
                            <input type="${inputType}" 
                                   class="form-control" 
                                   id="modalInput" 
                                   value="${defaultValue}"
                                   ${inputType === 'number' ? 'min="0" step="0.1"' : ''}>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Отмена
                        </button>
                        <button type="button" class="btn btn-success" id="confirmButton">
                            <i class="fas fa-check me-2"></i>Подтвердить
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        const input = modal.querySelector('#modalInput');
        const confirmBtn = modal.querySelector('#confirmButton');
        
        // Фокус на input при открытии
        modal.addEventListener('shown.bs.modal', () => {
            input.focus();
            input.select();
        });
        
        // Подтверждение по Enter
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmBtn.click();
            }
        });
        
        // Обработчики кнопок
        modal.querySelector('.btn-secondary').onclick = () => {
            bsModal.hide();
            resolve(null);
        };
        
        confirmBtn.onclick = () => {
            const value = input.value.trim();
            bsModal.hide();
            resolve(value);
        };
        
        // Закрытие по ESC
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                bsModal.hide();
                resolve(null);
            }
        });
        
        // Убираем модальное окно после закрытия
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
        
        bsModal.show();
    });
}

// Функция для подтверждения действий
function confirmWithModal(title, message, details = '') {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2 text-warning"></i>${title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>${message}</strong></p>
                        ${details ? `<div class="text-muted"><small>${details}</small></div>` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Отмена
                        </button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteButton">
                            <i class="fas fa-check me-2"></i>Подтвердить
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        
        // Обработчики кнопок
        modal.querySelector('.btn-secondary').onclick = () => {
            bsModal.hide();
            resolve(false);
        };
        modal.querySelector('#confirmDeleteButton').onclick = () => {
            bsModal.hide();
            resolve(true);
        };
        
        // Убираем модальное окно после закрытия
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
        
        bsModal.show();
    });
}

// Улучшенная функция показа уведомлений
function showNotification(message, type = 'info', duration = 4000) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    
    const icons = {
        success: 'check-circle',
        danger: 'exclamation-triangle',
        warning: 'exclamation-circle',
        info: 'info-circle'
    };
    
    notification.innerHTML = `
        <i class="fas fa-${icons[type] || 'info-circle'} me-2"></i>
        <span>${message}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Автоматически удаляем через указанное время
    setTimeout(() => {
        if (notification.parentNode) {
            const bsAlert = bootstrap.Alert.getInstance(notification);
            if (bsAlert) {
                bsAlert.close();
            } else {
                notification.remove();
            }
        }
    }, duration);
    
    return notification;
}

// Функция для автоматического обновления данных
let autoUpdateInterval = null;

function startAutoUpdate() {
    // Останавливаем предыдущий интервал если есть
    if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
    }
    
    // Запускаем автообновление каждые 30 секунд
    autoUpdateInterval = setInterval(async () => {
        try {
            // Проверяем, видна ли страница пользователю
            if (document.hidden) {
                return;
            }
            
            // Обновляем только данные склада (без UI шума)
            const response = await fetch('/api/sklad');
            const skladData = await response.json();
            
            if (skladData && skladData.склад) {
                // Тихо обновляем значения в полях ввода если они не в фокусе
                updateWarehouseInputsQuietly(skladData.склад);
            }
        } catch (error) {
            console.log('Ошибка автообновления:', error);
        }
    }, 30000);
}

function stopAutoUpdate() {
    if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
        autoUpdateInterval = null;
    }
}

// Тихое обновление полей склада (без уведомлений)
function updateWarehouseInputsQuietly(skladData) {
    for (const [productName, productData] of Object.entries(skladData)) {
        const input = document.querySelector(`input[data-product="${productName}"]`);
        
        // Обновляем только если поле не в фокусе
        if (input && input !== document.activeElement) {
            const currentValue = parseFloat(input.value) || 0;
            const newValue = productData.количество || 0;
            
            if (currentValue !== newValue) {
                input.value = newValue;
            }
        }
        
        // Обновляем срок годности
        const expirationInput = document.querySelector(`input.expiration-date[data-product="${productName}"]`);
        if (expirationInput && expirationInput !== document.activeElement) {
            const newExpirationDate = productData.срок_годности || '';
            if (expirationInput.value !== newExpirationDate) {
                expirationInput.value = newExpirationDate;
                updateProductStatus(productName, newExpirationDate);
            }
        }
    }
}



// SPA навигация отключена для корректной инициализации скриптов страниц

// Показать индикатор загрузки
function showLoadingIndicator() {
    const indicator = document.createElement('div');
    indicator.className = 'position-fixed d-flex justify-content-center align-items-center';
    indicator.style.cssText = 'top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 10000;';
    indicator.innerHTML = `
        <div class="bg-white rounded p-4 text-center">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <div>Загружаем...</div>
        </div>
    `;
    document.body.appendChild(indicator);
    return indicator;
}

// Скрыть индикатор загрузки
function hideLoadingIndicator(indicator) {
    if (indicator && indicator.parentNode) {
        indicator.remove();
    }
}

// Инициализация страницы после загрузки нового контента
function initializePage() {
    // Перезапускаем все обработчики событий
    if (typeof updateAllProductStatuses === 'function') {
        updateAllProductStatuses();
    }
    
    // Запускаем автообновление
    startAutoUpdate();
    
    // Инициализируем обработчики для полей ввода
    const inputs = document.querySelectorAll('.quick-edit');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            const product = this.dataset.product;
            const quantity = parseFloat(this.value);
            
            if (!isNaN(quantity) && quantity >= 0) {
                updateProductQuantity(product, quantity);
            }
        });
    });
    
    // Инициализируем обработчики для срока годности
    const expirationInputs = document.querySelectorAll('.expiration-date');
    expirationInputs.forEach(input => {
        input.addEventListener('change', function() {
            const product = this.dataset.product;
            const expirationDate = this.value;
            updateProductExpiration(product, expirationDate);
        });
    });
}

// Вспомогательная функция для обновления количества продукта
function updateProductQuantity(product, quantity) {
    fetch(`/api/update/${encodeURIComponent(product)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success', 2000);
            
            // Обновляем список покупок после изменения количества
            setTimeout(async () => {
                await updateShoppingListFromAPI();
            }, 500);
        }
    })
    .catch(error => {
        console.error('Ошибка обновления:', error);
        showNotification('Ошибка при обновлении количества', 'danger');
    });
}

// Вспомогательная функция для обновления срока годности
function updateProductExpiration(product, expirationDate) {
    // Получаем текущее количество продукта
    const quantityInput = document.querySelector(`input[data-product="${product}"]`);
    const currentQuantity = quantityInput ? parseFloat(quantityInput.value) || 0 : 0;
    
    fetch(`/api/update/${encodeURIComponent(product)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            quantity: currentQuantity,
            expiration_date: expirationDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateProductStatus(product, expirationDate);
        } else {
            console.error('Ошибка обновления срока годности:', data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка обновления срока годности:', error);
    });
}

// Функция для обновления списка покупок через API
async function updateShoppingListFromAPI() {
    try {
        const response = await fetch('/api/needed_products');
        const data = await response.json();
        
        if (data.success) {
            // Обновляем список покупок с новыми данными
            updateShoppingList(data.needed_products);
        } else {
            console.error('Ошибка получения списка покупок:', data.error);
        }
    } catch (error) {
        console.error('Ошибка при обновлении списка покупок:', error);
    }
}

// Функция для плавной прокрутки к рецепту
function scrollToRecipe(mealName) {
    const recipeElement = document.getElementById('recipe-' + mealName);
    if (recipeElement) {
        // Добавляем небольшой отступ сверху для лучшего отображения
        const offset = 100;
        const elementPosition = recipeElement.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - offset;
        
        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
        
        // Добавляем подсветку элемента
        recipeElement.style.transition = 'all 0.3s ease';
        
        // Разные цвета подсветки для разных типов блюд
        if (recipeElement.classList.contains('ready-meal')) {
            // Готовые блюда (не требующие приготовления)
            recipeElement.style.backgroundColor = '#e8f5e8';
            recipeElement.style.border = '2px solid #28a745';
        } else {
            // Блюда для приготовления
            recipeElement.style.backgroundColor = '#fff3cd';
            recipeElement.style.border = '2px solid #ffc107';
        }
        
        // Убираем подсветку через 2 секунды
        setTimeout(() => {
            recipeElement.style.backgroundColor = '';
            recipeElement.style.border = '';
        }, 2000);
    } else {
        // Уведомление убрано по запросу пользователя
    }
}
</script>
{% endblock %}
